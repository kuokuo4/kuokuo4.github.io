#!/usr/bin/env node
const program = require('commander')
const prompts = require('prompts')
const { writeCredentials } = require('../utils')
const axios = require('axios')
const authRequest = require('../authRequest')
const TOKEN_NAME = 'keke'

async function login (
  source,
  options
) {
  const { phone } = await prompts({
    type: 'text',
    name: 'phone',
    message: 'è¯·å¡«å†™ä½ çš„æ‰‹æœºå·'
  })
  await axios.post('https://auth.midway.run/api/user/getVerifyCode', { mobile: phone })
  console.log('âœ”éªŒè¯ç å·²ç»å‘é€åˆ°ä½ çš„æ‰‹æœº')
  const { code } = await prompts({
    type: 'text',
    name: 'code',
    message: 'è¯·å¡«å†™æ‰‹æœºéªŒè¯ç '
  })
  try {
    const response = await axios.post('https://auth.midway.run/api/user/login', { mobile: phone, code: code })
    const token = response.headers['set-cookie'][0].split(';')[0].split('=')[1]
    authRequest.defaults.headers.common['cookie'] = `JIKE-AUTH-JWT=${token}`
    try {
      await authRequest.post('https://auth.midway.run/api/jtoken/upsert', { name: TOKEN_NAME, policies: ['fe-dpy'] })
    } catch (err) {}
    try {
      const tokenRes = await authRequest.post('https://auth.midway.run/api/jtoken/get', { name: TOKEN_NAME })
      if (tokenRes.data.token) {
        console.log('âœï¸å·²æ‰¾åˆ°tokenï¼Œå·²å†™å…¥æœ¬åœ°æ–‡ä»¶ ~/.keke/credentials ', tokenRes.data.token)
        writeCredentials('default', tokenRes.data.token)
        console.log('ğŸ‘Œç™»å½•æˆåŠŸ')
      }
    } catch (err) {
      console.log('âŒ æœªæ‰¾åˆ°tokenï¼Œ è¯·å°è¯•é‡æ–°è¿è¡Œ')
      console.log(err.data)
    }
  } catch (err) {
    console.log(err.data)
  }
}

function action (command) {
  login(command)
}

program
  .command('login')
  .description('ç™»å½•authcenterï¼Œè¯·æ ¹æ®æç¤ºæ“ä½œã€‚')
  .action(action)
